@using System.Collections.Generic
@{
    ViewBag.Title = "Выгрузка штрафов";
    Layout = "_Layout.cshtml";
}

<div class="row">
    <h2>Расчет штрафных санкций</h2>
</div>
<div class="row">
    <div class="well col-md-6">
        @if (Model.regionModel.Name == null)
        {
            <p> 
                <label class="control-label">Не удалось определить регион по ip-адресу</label>
            </p>
            <p>
                <label class="control-label">Ваш ip @Request.UserHostAddress</label>
            </p>
        }
        else
        {
            <form>
                <div class="form-group">
                    Ваш регион: <b>@Model.regionModel.Name</b>
                </div>
                <div class="form-group">
                    <label for="" class="control-label">Выбор текущего периода для расчета штрафов</label>
                    <br>
                    <select name="period" id="period" size="1">
                        @if (((IDictionary<string, object>) Model).ContainsKey("list"))
                        {
                            @foreach (var item in Model.list)
                             {
                                 @if (item.Selected)
                                  {
                                      <option value="@item.Value" selected>@item.Text</option>
                                  }
                                  else
                                  {
                                      <option value="@item.Value"> @item.Text </option>
                                  }
                             }
                        }
                    </select>
                </div>
                <input type="hidden" id="passkey" name="passkey" value="@Model.regionModel.Passkey" />
                <input type="hidden" id="region" name="region" value="@Model.regionModel.Name" />
                <input type="hidden" id="equip" name="equip" value="@Model.regionModel.EquipmentCoeff" />
                <input type="hidden" id="regional" name="regional" value="@Model.regionModel.RegionalCoeff"/>
                
                
                
                <div class="form-group">
                    <button id="submit_button" type="button" class="btn btn-primary btn-sm">Генерировать отчет</button>
                    <span id="spinner"><img src="~/Content/small_spinner.gif" /></span>
                </div>
                <div class="form-group">
                    <div id="result">
                        <label id="label_error_text" class="label-warning"></label>
                        <a href="#" id="link_report">Скачать отчет</a>
                    </div>
                </div>
            </form>
        }
</div>
</div>
    <script>
    $(document).ready(function () {
        $("#label_error_text").hide();
        $("#link_report").hide();
        $("#spinner").hide();
        $("#submit_button").click(function () {
            $("#spinner").show();
            $jsXHRObject = $.ajax({
                url: "",
                type: "post",
                dataType: "json",
                async: "false",
                data: { period: $("#period").val(), passkey: $("#passkey").val(),equip:$("#equip").val(),regional:$("#regional").val() }
            }).done(function (data) {
                $("#spinner").hide();
                if (data.result == true) {
                    $("#link_report").attr("href", "/get-file/"+data.resultText);
                    $("#link_report").show();
                } else {
                    $("#label_error_text").text(data.resultText);
                    $("#label_error_text").show();
                }
            });
        });
    });
</script>